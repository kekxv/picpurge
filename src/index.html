<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Util Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4361ee',
            secondary: '#3f37c9',
            success: '#4cc9f0',
            warning: '#f72585',
          }
        }
      }
    }
  </script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
  </style>
</head>
<body>
  <nav class="bg-gray-800 text-white shadow-lg sticky top-0 z-50">
    <div class="container mx-auto px-4">
      <a class="text-2xl font-bold" href="#">
        Image Util Dashboard
      </a>
    </div>
  </nav>

  <div class="container mx-auto px-4 max-w-7xl mt-8">
    <!-- Statistics Section -->
    <div class="bg-gray-800 text-white rounded-lg shadow-lg p-6 mb-8">
      <h2 class="text-2xl font-bold mb-4">Image Statistics</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="stats-grid">
        <!-- Stats will be rendered here -->
        <div class="flex justify-center items-center h-32">
          <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
        </div>
      </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="mb-4">
      <div class="relative">
        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
          <svg class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
          </svg>
        </span>
        <input type="text" class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:border-blue-300 focus:shadow-outline-blue sm:text-sm transition duration-150 ease-in-out" id="searchInput" placeholder="Search by filename...">
      </div>
    </div>

    <div class="flex space-x-2 mb-8">
      <button class="px-4 py-2 rounded-full text-sm font-medium bg-blue-500 text-white filter-btn active" data-filter="all">All Images</button>
      <button class="px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 filter-btn" data-filter="duplicates">Duplicates</button>
      <button class="px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 filter-btn" data-filter="similar">Similar</button>
      <button class="px-4 py-2 rounded-full text-sm font-medium bg-gray-200 text-gray-700 filter-btn" data-filter="unique">Unique</button>
    </div>

    <div class="space-y-8">
      <!-- Duplicate Groups Section -->
      <div class="">
        <div class="bg-white rounded-lg shadow-lg mb-8" id="duplicates-section">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-bold">Duplicate Image Groups</h2>
          </div>
          <div class="p-6" id="duplicates-content">
            <div id="duplicate-groups">
              <!-- Duplicate groups will be rendered here -->
              <div class="flex justify-center items-center h-32">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Similar Groups Section -->
      <div class="">
        <div class="bg-white rounded-lg shadow-lg mb-8" id="similar-section">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-bold">Similar Image Groups</h2>
          </div>
          <div class="p-6" id="similar-content">
            <div id="similar-groups">
              <!-- Similar groups will be rendered here -->
              <div class="flex justify-center items-center h-32">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Unique Images Section -->
      <div class="">
        <div class="bg-white rounded-lg shadow-lg mb-8" id="unique-section">
          <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-xl font-bold">Unique Images</h2>
          </div>
          <div class="p-6" id="unique-content">
            <div id="unique-images-grid">
              <!-- Unique images will be rendered here -->
              <div class="flex justify-center items-center h-32">
                <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="imagePreviewModal" class="modal hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
      <div class="relative bg-white max-w-4xl max-h-full rounded-lg overflow-hidden">
        <img class="w-full h-full object-contain" id="previewImage">
        <div id="caption" class="absolute bottom-4 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 text-white px-4 py-2 rounded-lg text-center"></div>
        <div id="groupInfo" class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-4 py-2 rounded-lg"></div>
        <button id="prevBtn" class="absolute top-1/2 left-4 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">&lt;</button>
        <button id="nextBtn" class="absolute top-1/2 right-4 -translate-y-1/2 bg-black bg-opacity-50 text-white p-2 rounded-full">&gt;</button>
        <button class="close absolute top-4 right-4 text-white text-2xl">&times;</button>
      </div>
    </div>

  <!-- Toast for notifications -->
  <div class="hidden fixed top-5 right-5 p-4 rounded-lg text-white" id="notificationToast">
    <div id="toastMessage"></div>
  </div>

  
  <script>
    // Global variables to store data
    let imageData = null;
    let currentFilter = 'all';
    let currentSearch = '';

    function parseCreateDate(create_date) {
      if (!create_date) {
          return null;
      }
      if (create_date instanceof Date) {
          return create_date;
      }
      if (typeof create_date === 'number') {
          if (create_date < 1e11) {
              return new Date(create_date * 1000);
          }
          return new Date(create_date);
      }
      if (typeof create_date === 'string') {
          let dateStr = create_date;
          if (/^\d{4}:\d{2}:\d{2}/.test(dateStr)) {
              dateStr = dateStr.substring(0, 10).replace(/:/g, '-') + dateStr.substring(10);
          }
          const parsedDate = new Date(dateStr);
          if (!isNaN(parsedDate.getTime())) {
              return parsedDate;
          }
      }
      return null;
    }

    function generateNewName(image) {
      const date = parseCreateDate(image.create_date) || new Date();

      const yyyy = date.getFullYear();
      const MM = String(date.getMonth() + 1).padStart(2, '0');
      const dd = String(date.getDate()).padStart(2, '0');
      const HH = String(date.getHours()).padStart(2, '0');
      const mm = String(date.getMinutes()).padStart(2, '0');
      const ss = String(date.getSeconds()).padStart(2, '0');
      const sequence = String(image.id).padStart(6, '0');
      const extension = image.file_name.split('.').pop();
      return `${yyyy}${MM}${dd}${HH}${mm}${ss}.${sequence}.${extension}`;
    }

    function showToast(message, isSuccess = true) {
      const toast = document.getElementById('notificationToast');
      const toastMessage = document.getElementById('toastMessage');
      
      toastMessage.textContent = message;
      toast.className = `fixed top-5 right-5 p-4 rounded-lg text-white ${
        isSuccess ? 'bg-green-500' : 'bg-red-500'
      }`;
      
      toast.classList.remove('hidden');
      setTimeout(() => {
        toast.classList.add('hidden');
      }, 3000);
    }

    // Initialize collapsible sections
    function initCollapsible() {
      const headers = document.querySelectorAll('[data-target]');
      headers.forEach(header => {
        header.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          const content = document.getElementById(targetId);
          const icon = this.querySelector('.collapsible-icon');
          
          content.classList.toggle('hidden');
          icon.classList.toggle('rotate-180');
        });
      });
    }

    // Initialize filter buttons
    function initFilters() {
      const filterButtons = document.querySelectorAll('.filter-btn');
      filterButtons.forEach(button => {
        button.addEventListener('click', function() {
          filterButtons.forEach(btn => {
            btn.classList.remove('bg-blue-500', 'text-white');
            btn.classList.add('bg-gray-200', 'text-gray-700');
          });
          
          this.classList.add('bg-blue-500', 'text-white');
          this.classList.remove('bg-gray-200', 'text-gray-700');
          
          currentFilter = this.getAttribute('data-filter');
          applyFilters();
        });
      });
      
      const searchInput = document.getElementById('searchInput');
      searchInput.addEventListener('input', function() {
        currentSearch = this.value.toLowerCase();
        applyFilters();
      });
    }

    function applyFilters() {
      if (!imageData) return;

      const duplicatesSection = document.getElementById('duplicates-section').parentElement;
      const similarSection = document.getElementById('similar-section').parentElement;
      const uniqueSection = document.getElementById('unique-section').parentElement;

      // Hide all sections initially
      duplicatesSection.classList.add('hidden');
      similarSection.classList.add('hidden');
      uniqueSection.classList.add('hidden');

      // Filter and render based on current filter and search
      switch(currentFilter) {
        case 'all':
          duplicatesSection.classList.remove('hidden');
          similarSection.classList.remove('hidden');
          uniqueSection.classList.remove('hidden');
          renderDuplicateGroups(imageData.duplicateGroups);
          renderSimilarGroups(imageData.similarGroups);
          renderUniqueImages(imageData.uniqueImages);
          break;
        case 'duplicates':
          duplicatesSection.classList.remove('hidden');
          renderDuplicateGroups(imageData.duplicateGroups);
          break;
        case 'similar':
          similarSection.classList.remove('hidden');
          renderSimilarGroups(imageData.similarGroups);
          break;
        case 'unique':
          uniqueSection.classList.remove('hidden');
          renderUniqueImages(imageData.uniqueImages);
          break;
      }
    }

    window.onload = async () => {
      try {
        const response = await fetch('/api/images');
        imageData = await response.json();

        renderStats(imageData);
        renderDuplicateGroups(imageData.duplicateGroups);
        renderSimilarGroups(imageData.similarGroups);
        renderUniqueImages(imageData.uniqueImages);

        setupImagePreview();
        initCollapsible();
        initFilters();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('Error loading data. Please refresh the page.', false);
      }
    };

    function renderStats(data) {
      const statsGrid = document.getElementById('stats-grid');
      statsGrid.innerHTML = `
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <span class="text-4xl font-bold">${data.totalImages}</span>
          <span class="text-sm text-gray-400 mt-2 block">Total Images</span>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <span class="text-4xl font-bold">${data.duplicateGroupCount}</span>
          <span class="text-sm text-gray-400 mt-2 block">Duplicate Groups</span>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <span class="text-4xl font-bold">${data.similarGroupCount}</span>
          <span class="text-sm text-gray-400 mt-2 block">Similar Groups</span>
        </div>
        <div class="bg-gray-700 p-4 rounded-lg text-center">
          <span class="text-4xl font-bold">${data.uniqueImageCount}</span>
          <span class="text-sm text-gray-400 mt-2 block">Unique Images</span>
        </div>
      `;
    }

    function renderDuplicateGroups(groups) {
      const container = document.getElementById('duplicate-groups');
      if (groups.length === 0) {
        container.innerHTML = '<div class="text-gray-500">No duplicate image groups found.</div>';
        return;
      }
      container.innerHTML = groups.map(groupImages => {
        const groupKey = groupImages[0].id;
        return `
          <div class="mb-8">
            <h3 class="text-lg font-semibold mb-2">Group: ${groupKey} (${groupImages.length} images)</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
              ${groupImages.map(d => {
                const thumbnailSrc = d.thumbnail_path ? `/thumbnails/${d.thumbnail_path.split('/').pop()}` : '';
                const newName = generateNewName(d);
                return `
                  <div class="border rounded-lg overflow-hidden shadow-md">
                    ${thumbnailSrc ? `<img src="${thumbnailSrc}" alt="${d.file_name}" class="w-full h-32 object-cover cursor-pointer" data-image-id="${d.id}" data-group-ids="${groupKey}" data-group-type="duplicate">` : '<div class="w-full h-32 bg-gray-200 flex items-center justify-center"><svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg></div>'}
                    <div class="p-2">
                      <div class="text-sm font-semibold truncate" title="${d.file_name}">${d.file_name}</div>
                      <div class="text-xs text-gray-500 truncate" title="${newName}">${newName}</div>
                      <div class="text-xs text-gray-500">${d.image_width}x${d.image_height}</div>
                      <button class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded text-xs" onclick="recycle('${d.file_path.replace(/'/g, "\'")}', this)">Recycle</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderSimilarGroups(groups) {
      const container = document.getElementById('similar-groups');
      if (groups.length === 0) {
        container.innerHTML = '<div class="text-gray-500">No similar image groups found.</div>';
        return;
      }
      container.innerHTML = groups.map(groupImages => {
        const groupKey = groupImages.map(i => i.id).sort().join('-');
        return `
          <div class="mb-8">
            <h3 class="text-lg font-semibold mb-2">Group: ${groupKey} (${groupImages.length} images)</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
              ${groupImages.map(s => {
                const thumbnailSrc = s.thumbnail_path ? `/thumbnails/${s.thumbnail_path.split('/').pop()}` : '';
                const newName = generateNewName(s);
                return `
                  <div class="border rounded-lg overflow-hidden shadow-md">
                    ${thumbnailSrc ? `<img src="${thumbnailSrc}" alt="${s.file_name}" class="w-full h-32 object-cover cursor-pointer" data-image-id="${s.id}" data-group-ids="${groupKey}" data-group-type="similar">` : '<div class="w-full h-32 bg-gray-200 flex items-center justify-center"><svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg></div>'}
                    <div class="p-2">
                      <div class="text-sm font-semibold truncate" title="${s.file_name}">${s.file_name}</div>
                      <div class="text-xs text-gray-500 truncate" title="${newName}">${newName}</div>
                      <div class="text-xs text-gray-500">${s.image_width}x${s.image_height}</div>
                      <button class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded text-xs" onclick="recycle('${s.file_path.replace(/'/g, "\'")}', this)">Recycle</button>
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }).join('');
    }

    function renderUniqueImages(images) {
      const container = document.getElementById('unique-images-grid');
      if (images.length === 0) {
        container.innerHTML = '<div class="text-gray-500">No unique images found.</div>';
        return;
      }
      container.innerHTML = `
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          ${images.map(u => {
            const thumbnailSrc = u.thumbnail_path ? `/thumbnails/${u.thumbnail_path.split('/').pop()}` : '';
            const newName = generateNewName(u);
            return `
              <div class="border rounded-lg overflow-hidden shadow-md">
                ${thumbnailSrc ? `<img src="${thumbnailSrc}" alt="${u.file_name}" class="w-full h-40 object-cover cursor-pointer" data-image-id="${u.id}" data-group-type="unique">` : '<div class="w-full h-40 bg-gray-200 flex items-center justify-center"><svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 14m6-6l.01.01"></path></svg></div>'}
                <div class="p-2">
                  <div class="text-sm font-semibold truncate" title="${u.file_name}">${u.file_name}</div>
                  <div class="text-xs text-gray-500 truncate" title="${newName}">${newName}</div>
                  <div class="text-xs text-gray-500">${u.image_width}x${u.image_height}</div>
                  <button class="mt-2 w-full bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded text-xs" onclick="recycle('${u.file_path.replace(/'/g, "\'")}', this)">Recycle</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    function setupImagePreview() {
      const modal = document.getElementById("imagePreviewModal");
      const modalImg = document.getElementById("previewImage");
      const captionText = document.getElementById("caption");
      const closeBtn = modal.querySelector(".close");
      const prevBtn = document.getElementById("prevBtn");
      const nextBtn = document.getElementById("nextBtn");
      const groupInfo = document.getElementById("groupInfo");
      
      let currentImageId = null;
      let currentGroup = null;
      let currentGroupIndex = -1;
      let allImagesInGroup = [];
      
      function findGroupImages(imageElement) {
        const groupType = imageElement.getAttribute('data-group-type');
        const groupIds = imageElement.getAttribute('data-group-ids');
        
        if (groupType === 'unique') {
          const allUniqueImages = Array.from(document.querySelectorAll('img[data-group-type="unique"]'));
          return {
            type: 'unique',
            images: allUniqueImages
          };
        }
        
        const selector = `[data-group-ids="${groupIds}"][data-group-type="${groupType}"]`;
        const groupImages = Array.from(document.querySelectorAll(selector));
        
        return {
          type: groupType,
          ids: groupIds,
          images: groupImages
        };
      }
      
      function navigateGroup(direction) {
        if (allImagesInGroup.length === 0 || currentGroupIndex === -1) return;
        
        let newIndex = currentGroupIndex + direction;
        
        if (newIndex < 0) {
          newIndex = allImagesInGroup.length - 1;
        } else if (newIndex >= allImagesInGroup.length) {
          newIndex = 0;
        }
        
        currentGroupIndex = newIndex;
        const newImageElement = allImagesInGroup[newIndex];
        const newImageId = parseInt(newImageElement.getAttribute('data-image-id'));
        currentImageId = newImageId;
        
        const timestamp = new Date().getTime();
        modalImg.src = `/api/image/${newImageId}?t=${timestamp}`;
        captionText.innerHTML = newImageElement.alt;
        
        if (currentGroup.type !== 'unique') {
          groupInfo.innerHTML = `Group: ${currentGroup.ids} (${newIndex + 1}/${allImagesInGroup.length})`;
        } else {
          groupInfo.innerHTML = `Unique Images (${newIndex + 1}/${allImagesInGroup.length})`;
        }
      }
      
      document.addEventListener('click', function(e) {
        if (e.target.tagName === 'IMG' && e.target.hasAttribute('data-image-id')) {
          const imageElement = e.target;
          const imageId = parseInt(imageElement.getAttribute('data-image-id'));
          
          if (imageId) {
            currentImageId = imageId;
            currentGroup = findGroupImages(imageElement);
            allImagesInGroup = currentGroup.images;
            currentGroupIndex = allImagesInGroup.findIndex(img => parseInt(img.getAttribute('data-image-id')) === imageId);
            
            if (allImagesInGroup.length > 1) {
              prevBtn.style.display = 'block';
              nextBtn.style.display = 'block';
            } else {
              prevBtn.style.display = 'none';
              nextBtn.style.display = 'none';
            }
            
            if (currentGroup.type !== 'unique') {
              groupInfo.innerHTML = `Group: ${currentGroup.ids} (${currentGroupIndex + 1}/${allImagesInGroup.length})`;
            } else {
              groupInfo.innerHTML = 'Unique Image';
            }
            
            const timestamp = new Date().getTime();
            modal.classList.remove('hidden');
            modalImg.src = `/api/image/${imageId}?t=${timestamp}`;
            captionText.innerHTML = imageElement.alt;
          }
        }
      });
      
      closeBtn.onclick = function() {
        modal.classList.add('hidden');
      }
      
      modal.onclick = function(event) {
        if (event.target === modal) {
          modal.classList.add('hidden');
        }
      }

      prevBtn.onclick = () => navigateGroup(-1);
      nextBtn.onclick = () => navigateGroup(1);

      document.addEventListener('keydown', function(event) {
        if (!modal.classList.contains('hidden')) {
          if (event.key === 'ArrowLeft') {
            navigateGroup(-1);
          } else if (event.key === 'ArrowRight') {
            navigateGroup(1);
          } else if (event.key === 'Escape') {
            modal.classList.add('hidden');
          }
        }
      });
    }

    async function recycle(filePath, buttonElement) {
      if (!confirm('Are you sure you want to recycle this file?')) {
        return;
      }
      
      const originalText = buttonElement.innerHTML;
      buttonElement.disabled = true;
      buttonElement.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mx-auto"></div>';
      
      try {
        const response = await fetch('/api/recycle', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ filePath }) 
        });
        const data = await response.json();
        if (data.success) {
          showToast('File recycled successfully!');
          setTimeout(() => {
            const card = buttonElement.closest('.border');
            if (card) {
              card.style.transition = 'opacity 0.3s ease';
              card.style.opacity = '0';
              setTimeout(() => {
                card.remove();
                if (imageData) {
                  imageData.totalImages--;
                  renderStats(imageData);
                }
              }, 300);
            }
          }, 1000);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Error recycling file:', error);
        showToast(`Error recycling file: ${error.message}`, false);
        buttonElement.disabled = false;
        buttonElement.innerHTML = originalText;
      }
    }
  </script>
</body>
</html>